---
title: "2024-05-18 github actions cd 구축"
layout: single
author_profile: true
tags:
  - github
  - cd
  - ec2
---

github actions로 ec2에 지속적 배포(cd) 하기

# 아이디어 스케치

- 만약 내가 dev 단계의 어플리케이션을 확인하고 싶다면 어떻게 하는 것이 좋을까?
- pr로 main에 push 될 때마다 개발 서버에 배포되는 것이 좋을 거 같다
  - why?
  - 개발 환경에서는 기능 개발이 완료 될 때마다 배포가 되더라도, 회사 내 개발자 혹은 기획자들이 확인만 할 것이다.
  - 따라서 개발 서버의 네트워크 상태는 사내에서만 접근 되도록 망이 구성되어 있어야 겠다.
  - 다만 stage 와 production level 에서는 실제 환경 배포를 위해 jenkins 등으로 배포를 선택적으로 할 수 있도록 구축하자.

# 구축하기

- 일단 무중단 배포를 위해 load balancer(nginx)를 구축하자
- 무중단 배포는 blue/green 으로 선택했다.
  - why?
  - was는 하나만 떠 있을 예정이므로 하나 더 띄운다고 해서 오버헤드가 없을 거 같다
  - 또한 개인적인 생각으로는 구축할 때 가장 편한 방법이라고 생각했다.

## nginx 설치하기

- ec2에 nginx를 설치하자

```shell
sudo yum update -y
sudo yum install nginx
```

- nginx 를 띄우자

```shell
sudo systemctl start nginx 
sudo systemctl status nginx  # nginx 상태 확인
```

- reverse proxy 세팅을 하자

```shell
# /etc/nginx/conf.d/<파일이름>.conf
upstream backend_server {
    server 127.0.0.1:8000;
}

server {
    listen 8001;

    location /blog-site {
        proxy_pass  http://backend_server/;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    location ~ /admin {
        # 허용할 IP 주소
        allow 허용할 IP;
        deny all;

        rewrite ^/(?P<path>.*)/admin/(.*) /admin/$2 break;
        proxy_pass http://backend_server;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

}
```

- `/admin/` 이라는 path 가 붙어있다면 접근 제한을 하도록 수정했다
- `rewrite`를 통해 was에 도달하는 url path를 수정한다.